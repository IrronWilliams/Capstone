<!DOCTYPE html>


{% load static %}

<meta charset="utf-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Voter Turnout Rates</title>
    
  <!-- Bootstrap stylesheet -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.overlay {
  fill: none;
  pointer-events: all;
}

.focus circle {
  fill: none;
  stroke: steelblue;
}
</style>

<body>
<div class = "container">
 <!-- Title -->
        <h6 class="title has-text-centered font-weight-bold">National Midterm Election Turnout Rates: Historical Perspective  </h6>

    <button id="start" style="position: absolute; margin-left: 6px; margin-top: 6px;">Start Time Animation</button>
    <button id="reset" style="position: absolute; margin-left: 150px; margin-top: 6px">Reset</button>
    <p style="position: absolute; margin-left: 212px; margin-top: 12px; text-size: 12px">Start animation, then hover over line to see percentages.</p>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  
 
  <script>
 
  let margin = {top: 60, right: 20, bottom: 30, left: 50},
      width = 700 - margin.left - margin.right,
      height = 365 - margin.top - margin.bottom;

  // Parsing data to show in tooltip
  let parseDate = d3.time.format("%Y").parse, //formatters for how data formatted in csv; %Y for full year 
      bisectDate = d3.bisector(function(d) { return d.date; }).left,
      formatValue = d3.format(",.2f"),
      formatCurrency = function(d) { return formatValue(d) + "%"; };

  let x = d3.time.scale()
      .range([0, width]);

  let y = d3.scale.linear()
      .range([height, 0]);

  let xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  let yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

  let line = d3.svg.line()
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y(d.rate); });

  let svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  d3.csv("{% static 'capstoneapp/voter_rates_midterm.csv' %}", function(error, data) {
      if (error) throw error;
      console.log(data);

      data.forEach(function(d) { //looping through each row parsing date and converting rate column
          d.date = parseDate(d.date);
          d.rate = +d.rate; // + converts rate column to number
      });

      x.domain(d3.extent(data, function(d) { return d.date; }));
      y.domain(d3.extent(data, function(d) { return d.rate; }));

      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("turnout (%)");

    //this is where the line is created and the data is being bound to the line, where the svg path is appended to page
    // To start animation on click, put the entire creation of SVG and associated animating transiton 
    //within the D3 click event
    d3.select("#start").on("click", function() {
        let path = svg.append("path")
          .datum(data)
          .attr("class", "line")
          .attr("d", line);

      //The block of code for totalLength and path gets the total length of the line,
      //sets the dasharry and dashoffset properties to the total length, 
      //then sets up the transition to adjust the dash offset to zero.
      //this leads to an animation that makes the graph appear that it is unraveling over time.

      // Variable to hold total length of the path, needed for stroke dash affect 
      let totalLength = path.node().getTotalLength();

      // Set Properties of Dash Array and Dash Offset and initiate Transition (unrolls the line on chart)
      path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition() // Call Transition Method
          .duration(4000) // Set Duration timing (ms)
          .ease("linear") // Set Easing option
          .attr("stroke-dashoffset", 0); // Set final value of dash-offset for transition

      // Create SVG for Tooltip and Circle on Mouseover
      let focus = svg.append("g")
          .attr("class", "focus")
          .style("display", "none");

      // Append a circle to show on Mouseover
      focus.append("circle")
          .attr("r", 4.5);

      // Append text to show on Mouseover
      focus.append("text")
          .attr("x", 9)
          .attr("dy", ".35em");

      // Append overlay rectangle as container for Circle and Tooltips
      // that allows user to hover anywhere on graphic
      svg.append("rect")
          .attr("class", "overlay")
          .attr("width", width)
          .attr("height", height)
          .on("mouseover", function() { focus.style("display", null); })
          .on("mouseout", function() { focus.style("display", "none"); })
          .on("mousemove", mousemove);

      // Mousemove function that sets location and changes properties of Focus SVG
      function mousemove() {
        let x0 = x.invert(d3.mouse(this)[0]),
            i = bisectDate(data, x0, 1),
            d0 = data[i - 1],
            d1 = data[i],
            d = x0 - d0.date > d1.date - x0 ? d1 : d0;
        focus.attr("transform", "translate(" + x(d.date) + "," + y(d.rate) + ")");
        focus.select("text").text(formatCurrency(d.rate));
      }
    });

    // Reset Animation
    d3.select("#reset").on("click", function() {
      d3.select(".line").remove();
    });
  });

  </script>

</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>